{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>설정 작업</h2>
        <div class="card">
            <div class="card-body">
                <form id="configForm">
                    <div class="mb-3">
                        <label for="deviceSelect" class="form-label">장비 선택</label>
                        <select class="form-select" id="deviceSelect" required>
                            <option value="">장비를 선택하세요</option>
                        </select>
                    </div>
                    
                    <!-- 작업 유형 섹션 -->
                    <div class="card mb-4" id="taskTypeSection">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">작업 유형 (다중 선택 가능)</h5>
                                <button type="button" class="btn btn-sm btn-warning" id="resetTaskTypesBtn">작업 유형 테이블 초기화</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row" id="taskTypeContainer">
                                <!-- 작업 유형 체크박스가 여기에 로드됩니다 -->
                            </div>
                        </div>
                    </div>
                    
                    <div id="taskFormsContainer">
                        <!-- 선택된 작업 유형별 상세 작업 폼이 여기에 추가됩니다 -->
                    </div>
                    
                    <div class="mb-3">
                        <button type="button" id="generateScriptBtn" class="btn btn-primary" onclick="generateScript()">스크립트 생성</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 스크립트 출력 영역 -->
        <div id="scriptOutputContainer" class="card mt-4 d-none">
            <div class="card-header">
                <h5>생성된 스크립트</h5>
            </div>
            <div class="card-body">
                <textarea id="scriptOutput" class="form-control" rows="15" readonly></textarea>
                <div class="mt-3">
                    <button type="button" class="btn btn-success" onclick="copyScript()">복사</button>
                    <button type="button" class="btn btn-secondary" onclick="executeScript()">실행</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 스크립트 실행 결과 모달 -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">실행 결과</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="scriptResult" class="bg-light p-3"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 토스트 메시지 -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
    <div id="toast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong id="toast-title" class="me-auto">알림</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            <span id="toast-message"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 작업 유형 정의
const taskTypes = {
    'VLAN 관리': ['VLAN 생성', 'VLAN 삭제', '인터페이스 VLAN 할당', '트렁크 설정'],
    '포트 설정': ['액세스 모드 설정', '트렁크 모드 설정', '포트 속도 설정', '포트 듀플렉스 설정', '인터페이스 활성화'],
    '라우팅 설정': ['정적 라우팅', 'OSPF 설정', 'EIGRP 설정', 'BGP 설정'],
    '보안 설정': ['Port Security', 'SSH/Telnet 제한', 'AAA 인증', 'ACL 설정'],
    'STP 및 LACP': ['STP 설정', 'LACP/포트 채널 구성'],
    'QoS 및 트래픽 제어': ['QoS 정책 적용', '트래픽 제한', '서비스 정책 설정'],
    '라우팅 상태 모니터링': ['라우팅 테이블 확인', 'OSPF 이웃 확인', 'BGP 상태 확인'],
    '네트워크 상태 점검': ['인터페이스 상태 확인', '트래픽 모니터링'],
    '로그 수집': ['시스템 로그 수집', '로그 파일 저장'],
    '구성 백업 및 복원': ['설정 백업', '설정 복원'],
    'SNMP 및 모니터링': ['SNMP 설정', 'CDP/LLDP 정보 수집'],
    '자동화 스크립트 확장': ['다중 장비 설정', '조건 검증']
};

// 장비 목록 로드
function loadDevices() {
    fetch('/device/api/devices')
        .then(response => response.json())
        .then(data => {
            const deviceSelect = document.getElementById('deviceSelect');
            deviceSelect.innerHTML = '<option value="">장비를 선택하세요</option>';
            data.forEach(device => {
                deviceSelect.innerHTML += `<option value="${device.id}" data-vendor="${device.vendor}">${device.name} (${device.ip_address})</option>`;
            });
        })
        .catch(error => {
            console.error('장비 목록 로드 실패:', error);
            showToast('장비 목록을 불러오는데 실패했습니다.', 'error');
        });
}

// 작업 유형 목록 로드
function loadTaskTypes() {
    fetch('/config/api/task-types')
        .then(response => response.json())
        .then(data => {
            // 콘솔에 로그 추가
            console.log('받은 작업 유형 데이터:', data);
            
            const taskTypeContainer = document.getElementById('taskTypeContainer');
            taskTypeContainer.innerHTML = '';
            
            if (Array.isArray(data)) {
                data.forEach(taskType => {
                    // TaskType 객체 처리
                    const taskTypeName = typeof taskType === 'object' ? taskType.name : taskType;
                    const taskTypeId = typeof taskType === 'object' ? taskType.id : taskType.replace(/\s+/g, '_');
                    
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" 
                               value="${taskTypeName}" 
                               id="taskType_${taskTypeName.replace(/\s+/g, '_')}"
                               data-id="${taskTypeId}">
                        <label class="form-check-label" for="taskType_${taskTypeName.replace(/\s+/g, '_')}">
                            ${taskTypeName}
                        </label>
                    `;
                    taskTypeContainer.appendChild(div);
                });
                
                // 작업 유형이 있으면 폼을 표시
                if (data.length > 0) {
                    document.getElementById('taskTypeSection').classList.remove('d-none');
                } else {
                    document.getElementById('taskTypeSection').classList.add('d-none');
                    showToast('등록된 작업 유형이 없습니다.', 'warning');
                }
            } else {
                showToast('작업 유형 데이터 형식이 올바르지 않습니다.', 'error');
                console.error('잘못된 작업 유형 데이터 형식:', data);
            }
        })
        .catch(error => {
            console.error('작업 유형 목록 로드 실패:', error);
            showToast('작업 유형 목록을 불러오는데 실패했습니다.', 'error');
        });
}

// 작업 유형 선택 시 상세 작업 폼 업데이트
function updateTaskForms() {
    const taskFormsContainer = document.getElementById('taskFormsContainer');
    const selectedTaskTypes = Array.from(document.querySelectorAll('#taskTypeContainer input[type="checkbox"]:checked')).map(cb => ({ 
        name: cb.value,
        id: cb.dataset.id 
    }));
    
    // 선택된 작업 유형 없으면 스크립트 생성 버튼 비활성화
    document.getElementById('generateScriptBtn').disabled = selectedTaskTypes.length === 0;
    
    // 선택된 작업 유형에 대한 폼만 유지
    const existingForms = Array.from(document.querySelectorAll('.task-form'));
    existingForms.forEach(form => {
        const formTaskType = form.dataset.taskType;
        if (!selectedTaskTypes.some(tt => tt.name === formTaskType)) {
            form.remove();
        }
    });
    
    // 매핑된 작업 유형을 원래 유형으로 되돌리는 역매핑 테이블
    const reverseTaskTypeMapping = {
        'VLAN 생성/삭제': 'VLAN 관리',
        '인터페이스 설정': '포트 설정'
    };
    
    // 새로 선택된 작업 유형에 대한 폼 추가
    selectedTaskTypes.forEach(taskType => {
        const taskTypeName = taskType.name;
        
        if (!document.querySelector(`.task-form[data-task-type="${taskTypeName}"]`)) {
            // 역매핑: 매핑된 이름이 있으면 원래 작업 유형으로 변환, 없으면 그대로 사용
            const originalTaskType = reverseTaskTypeMapping[taskTypeName] || taskTypeName;
            
            console.log(`상세 작업 로드: ${originalTaskType} (원본: ${taskTypeName})`);
            
            // 해당 작업 유형의 상세 작업 목록 로드
            fetch(`/config/api/subtasks/${encodeURIComponent(originalTaskType)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(subtasks => {
                    // 상세 작업 데이터 처리 - 항상 문자열로 변환
                    const processedSubtasks = subtasks.map(subtask => {
                        if (typeof subtask === 'string') {
                            return { id: subtask, name: subtask };
                        } else if (typeof subtask === 'object' && subtask !== null) {
                            return { 
                                id: subtask.name || subtask.id || Object.keys(subtask)[0] || '', 
                                name: subtask.name || subtask.id || Object.keys(subtask)[0] || '알 수 없는 작업'
                            };
                        } else {
                            return { id: String(subtask), name: String(subtask) };
                        }
                    });

                    const formDiv = document.createElement('div');
                    formDiv.className = 'task-form card mb-3';
                    formDiv.dataset.taskType = taskTypeName;
                    
                    formDiv.innerHTML = `
                        <div class="card-header">
                            <h5 class="mb-0">${taskTypeName}</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="subtask_${taskTypeName.replace(/\s+/g, '_')}" class="form-label">상세 작업</label>
                                <select class="form-select subtask-select" id="subtask_${taskTypeName.replace(/\s+/g, '_')}" required data-task-type="${taskTypeName}">
                                    <option value="">상세 작업을 선택하세요</option>
                                    ${processedSubtasks.map(subtask => `<option value="${subtask.id}">${subtask.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="config-details" id="config_${taskTypeName.replace(/\s+/g, '_')}">
                                <!-- 상세 작업 선택 시 여기에 설정 폼이 추가됩니다 -->
                            </div>
                        </div>
                    `;
                    
                    taskFormsContainer.appendChild(formDiv);
                    
                    // 상세 작업 선택 이벤트 리스너 추가
                    const subtaskSelect = formDiv.querySelector('.subtask-select');
                    subtaskSelect.addEventListener('change', function() {
                        loadConfigParameters(taskTypeName, this.value);
                    });
                })
                .catch(error => {
                    console.error(`${taskTypeName}의 상세 작업 로드 실패:`, error);
                    showToast(`${taskTypeName}의 상세 작업을 불러오는데 실패했습니다.`, 'error');
                });
        }
    });
}

// 상세 작업 선택 시 설정 파라미터 로드
function loadConfigParameters(taskType, subtask) {
    // 문자열 형식 확인 및 강제 변환
    const safeTaskType = typeof taskType === 'string' ? taskType : String(taskType || '');
    let safeSubtask = '';
    
    // subtask가 객체인 경우 처리
    if (typeof subtask === 'object' && subtask !== null) {
        // 객체에서 name 속성 또는 첫 번째 속성 사용
        if (subtask.name) {
            safeSubtask = String(subtask.name);
        } else if (Object.keys(subtask).length > 0) {
            safeSubtask = String(Object.keys(subtask)[0]);
        } else {
            console.error('상세 작업 객체에서 사용할 속성을 찾을 수 없습니다:', subtask);
            showToast('상세 작업 정보가 유효하지 않습니다.', 'error');
            return;
        }
    } else {
        // 문자열이 아닌 경우 문자열로 변환
        safeSubtask = String(subtask || '');
    }
    
    if (!safeTaskType || !safeSubtask) {
        console.error('작업 유형 또는 상세 작업이 지정되지 않았습니다.');
        return;
    }
    
    if (safeSubtask === '[object Object]') {
        console.error('상세 작업이 객체로 처리되었습니다. 원본:', subtask);
        showToast('상세 작업 형식이 올바르지 않습니다.', 'error');
        return;
    }
    
    // 매핑된 작업 유형을 원래 유형으로 되돌리는 역매핑 테이블
    const reverseTaskTypeMapping = {
        'VLAN 생성/삭제': 'VLAN 관리',
        '인터페이스 설정': '포트 설정'
    };
    
    // 역매핑: 매핑된 이름이 있으면 원래 작업 유형으로 변환, 없으면 그대로 사용
    const originalTaskType = reverseTaskTypeMapping[safeTaskType] || safeTaskType;
    
    console.log(`파라미터 로드: ${originalTaskType}/${safeSubtask} (원본: ${safeTaskType}/${safeSubtask})`);
    
    const configContainerId = `config_${safeTaskType.replace(/\s+/g, '_')}`;
    const configContainer = document.getElementById(configContainerId);
    if (!configContainer) {
        console.error(`설정 컨테이너를 찾을 수 없음: ${configContainerId}`);
        return;
    }
    
    // 로딩 표시
    configContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">로딩중...</span></div></div>';
    
    fetch(`/config/api/parameters/${encodeURIComponent(originalTaskType)}/${encodeURIComponent(safeSubtask)}`)
        .then(response => {
            if (!response.ok) {
                // 백업 시도: 포트 설정/인터페이스 활성화로 시도
                if (originalTaskType !== '포트 설정' && safeSubtask !== '인터페이스 활성화') {
                    console.warn(`${originalTaskType}/${safeSubtask} 파라미터 로드 실패, 포트 설정으로 시도합니다.`);
                    return fetch(`/config/api/parameters/포트 설정/인터페이스 활성화`);
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(parameters => {
            // 응답 검증
            if (!Array.isArray(parameters)) {
                console.error('파라미터 응답이 배열이 아닙니다:', parameters);
                throw new Error('파라미터 데이터 형식이 올바르지 않습니다.');
            }
            
            if (parameters.length === 0) {
                configContainer.innerHTML = '<p class="text-muted">이 작업에 필요한 파라미터가 없습니다.</p>';
                return;
            }
            
            let formHtml = '<div class="row">';
            parameters.forEach(param => {
                formHtml += `
                    <div class="col-md-6 mb-3">
                        <label for="${param.name}_${safeTaskType.replace(/\s+/g, '_')}" class="form-label">${param.label || param.name}</label>
                        <input type="${param.type || 'text'}" 
                               class="form-control" 
                               id="${param.name}_${safeTaskType.replace(/\s+/g, '_')}" 
                               name="${param.name}" 
                               ${param.required ? 'required' : ''}
                               ${param.min !== undefined ? `min="${param.min}"` : ''}
                               ${param.max !== undefined ? `max="${param.max}"` : ''}
                               ${param.placeholder ? `placeholder="${param.placeholder}"` : ''}
                        >
                    </div>
                `;
            });
            formHtml += '</div>';
            configContainer.innerHTML = formHtml;
        })
        .catch(error => {
            console.error(`${safeTaskType}/${safeSubtask}의 파라미터 로드 실패:`, error);
            showToast(`파라미터 로드에 실패했습니다: ${error.message}`, 'error');
            configContainer.innerHTML = '<div class="alert alert-danger">파라미터 로드 실패</div>';
        });
}

// 스크립트 생성 호출
function generateScript() {
    const deviceSelect = document.getElementById('deviceSelect');
    const deviceId = deviceSelect.value;
    const selectedVendor = deviceSelect.options[deviceSelect.selectedIndex]?.dataset.vendor;
    
    if (!deviceId) {
        showToast('장비를 선택해주세요.', 'error');
        return;
    }
    
    if (!selectedVendor) {
        showToast('선택한 장비의 벤더 정보가 없습니다.', 'error');
        return;
    }
    
    const selectedTaskTypes = Array.from(document.querySelectorAll('#taskTypeContainer input[type="checkbox"]:checked')).map(cb => cb.value);
    
    if (selectedTaskTypes.length === 0) {
        showToast('하나 이상의 작업 유형을 선택해주세요.', 'error');
        return;
    }
    
    // 매핑된 작업 유형을 원래 유형으로 되돌리는 역매핑 테이블
    const reverseTaskTypeMapping = {
        'VLAN 생성/삭제': 'VLAN 관리',
        '인터페이스 설정': '포트 설정'
    };
    
    // 각 작업 유형의 상세 작업과 파라미터 수집
    const tasks = {};
    const originalTaskTypes = [];
    let isValid = true;
    
    selectedTaskTypes.forEach(taskType => {
        // 역매핑: 매핑된 이름이 있으면 원래 작업 유형으로 변환, 없으면 그대로 사용
        const originalTaskType = reverseTaskTypeMapping[taskType] || taskType;
        originalTaskTypes.push(originalTaskType);
        
        const selectId = `subtask_${taskType.replace(/\s+/g, '_')}`;
        const subtaskSelect = document.getElementById(selectId);
        
        if (!subtaskSelect) {
            console.error(`상세 작업 선택기를 찾을 수 없음: ${selectId}`);
            isValid = false;
            return;
        }
        
        const subtask = subtaskSelect.value;
        
        if (!subtask) {
            showToast(`${taskType}의 상세 작업을 선택해주세요.`, 'error');
            isValid = false;
            return;
        }
        
        const configId = `config_${taskType.replace(/\s+/g, '_')}`;
        const parametersDiv = document.getElementById(configId);
        
        if (!parametersDiv) {
            console.error(`파라미터 컨테이너를 찾을 수 없음: ${configId}`);
            isValid = false;
            return;
        }
        
        const parameterInputs = parametersDiv.querySelectorAll('input');
        const parameters = {};
        
        parameterInputs.forEach(input => {
            if (input.required && !input.value) {
                showToast(`${taskType}의 ${input.name} 파라미터를 입력해주세요.`, 'error');
                isValid = false;
                return;
            }
            parameters[input.name] = input.value;
        });
        
        tasks[originalTaskType] = {
            subtask,
            parameters
        };
    });
    
    if (!isValid) return;
    
    // API 호출 데이터 준비
    const requestData = {
        device_id: deviceId,
        task_types: originalTaskTypes,
        subtask_type: Object.fromEntries(originalTaskTypes.map(tt => [tt, tasks[tt].subtask])),
        vendor: selectedVendor,
        parameters: Object.fromEntries(originalTaskTypes.map(tt => [tt, tasks[tt].parameters]))
    };
    
    console.log('스크립트 생성 요청 데이터:', requestData);
    
    // API 호출
    fetch('/config/api/generate-script', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            const scriptOutput = document.getElementById('scriptOutput');
            const scriptOutputContainer = document.getElementById('scriptOutputContainer');
            
            if (scriptOutput && scriptOutputContainer) {
                scriptOutput.value = data.data.script;
                scriptOutputContainer.classList.remove('d-none');
                showToast('스크립트가 생성되었습니다.', 'success');
            } else {
                console.error('스크립트 출력 요소를 찾을 수 없음');
                showToast('스크립트 출력 요소를 찾을 수 없습니다.', 'error');
            }
        } else {
            showToast(data.message || '스크립트 생성에 실패했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('스크립트 생성 실패:', error);
        showToast('스크립트 생성 중 오류가 발생했습니다.', 'error');
    });
}

// 스크립트 복사
function copyScript() {
    const scriptOutput = document.getElementById('scriptOutput');
    scriptOutput.select();
    document.execCommand('copy');
    showToast('스크립트가 클립보드에 복사되었습니다.', 'success');
}

// 스크립트 실행
function executeScript() {
    const deviceId = document.getElementById('deviceSelect').value;
    const scriptContent = document.getElementById('scriptOutput').value;

    if (!deviceId || !scriptContent) {
        showToast('장비와 스크립트를 확인해주세요.', 'error');
        return;
    }

    fetch('/config/api/execute-script', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            device_id: deviceId,
            script: scriptContent
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('scriptResult').textContent = data.result || '명령이 성공적으로 실행되었습니다.';
            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            resultModal.show();
            showToast('스크립트가 실행되었습니다.', 'success');
        } else {
            showToast(data.message || '스크립트 실행에 실패했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('스크립트 실행 실패:', error);
        showToast('스크립트 실행 중 오류가 발생했습니다.', 'error');
    });
}

// 토스트 메시지 표시
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');
    
    toastTitle.textContent = type === 'success' ? '성공' : '오류';
    toastMessage.textContent = message;
    
    // Bootstrap 5의 Toast 객체 생성 및 표시
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// 이벤트 리스너 등록
document.addEventListener('DOMContentLoaded', () => {
    // 페이지 초기화
    initPage();
    
    // 작업 유형 테이블 초기화 버튼 이벤트 리스너
    const resetBtn = document.getElementById('resetTaskTypesBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            resetTaskTypes();
        });
    }
});

// 페이지 초기화
function initPage() {
    loadDevices();
    loadTaskTypes();
    
    // 작업 유형 체크박스 이벤트
    document.getElementById('taskTypeContainer').addEventListener('change', updateTaskForms);
    
    // 장비 선택 이벤트
    document.getElementById('deviceSelect').addEventListener('change', function() {
        // 작업 유형 체크박스 초기화
        const checkboxes = document.querySelectorAll('#taskTypeContainer input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        // 작업 폼 초기화
        document.getElementById('taskFormsContainer').innerHTML = '';
        
        // 스크립트 출력 영역 숨기기
        document.getElementById('scriptOutputContainer').classList.add('d-none');
    });
}

// 작업 유형 테이블 초기화
function resetTaskTypes() {
    if (!confirm('작업 유형 테이블을 초기화하시겠습니까? 모든 작업 유형이 기본값으로 재설정됩니다.')) {
        return;
    }
    
    fetch('/config/api/reset-task-types')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast('작업 유형 테이블이 초기화되었습니다. 총 ' + data.count + '개의 작업 유형이 추가되었습니다.', 'success');
                // 작업 유형 목록 다시 로드
                loadTaskTypes();
            } else {
                showToast('작업 유형 테이블 초기화 실패: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('작업 유형 테이블 초기화 실패:', error);
            showToast('작업 유형 테이블 초기화 중 오류가 발생했습니다.', 'error');
        });
}
</script>
{% endblock %} 