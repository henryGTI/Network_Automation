{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>네트워크 설정 작업</h2>
    
    <!-- 작업 유형 선택 -->
    <div class="form-group">
        <label for="taskType">작업 유형</label>
        <select class="form-control" id="taskType" onchange="loadFeatures()">
            <option value="">작업 유형을 선택하세요</option>
            <option value="시스템관리">시스템관리</option>
            <option value="네트워크관리">네트워크관리</option>
            <option value="LAYER2">LAYER2</option>
            <option value="QoS">QoS</option>
            <option value="보안">보안</option>
            <option value="패스워드복구">패스워드복구</option>
        </select>
    </div>

    <!-- Feature 선택 -->
    <div class="form-group">
        <label for="feature">Feature</label>
        <select class="form-control" id="feature" onchange="loadSubtasks()" disabled>
            <option value="">Feature를 선택하세요</option>
        </select>
    </div>

    <!-- 구분 선택 -->
    <div class="form-group">
        <label for="subtask">구분</label>
        <select class="form-control" id="subtask" onchange="loadParameters()" disabled>
            <option value="">구분을 선택하세요</option>
            <option value="config">설정</option>
            <option value="check">확인</option>
        </select>
    </div>

    <!-- 설정모드 선택 -->
    <div class="form-group">
        <label for="configMode">설정모드</label>
        <select class="form-control" id="configMode" onchange="updateParameters()" disabled>
            <option value="">설정모드를 선택하세요</option>
            <option value="기본">기본</option>
        </select>
    </div>

    <!-- 파라미터 입력 폼 -->
    <div id="parametersForm" class="mt-4">
        <!-- 파라미터들이 동적으로 추가됨 -->
    </div>

    <!-- 실행 버튼 -->
    <button id="executeButton" class="btn btn-primary mt-3" onclick="executeTask()" disabled>실행</button>

    <!-- 결과 표시 영역 -->
    <div id="resultArea" class="mt-4">
        <pre id="commandOutput" class="bg-light p-3 rounded"></pre>
    </div>
</div>

<script>
async function loadFeatures() {
    console.log("loadFeatures 호출됨");
    const taskType = document.getElementById('taskType').value;
    const featureSelect = document.getElementById('feature');
    const subtaskSelect = document.getElementById('subtask');
    const configModeSelect = document.getElementById('configMode');
    const executeButton = document.getElementById('executeButton');
    
    // 초기화
    featureSelect.innerHTML = '<option value="">Feature를 선택하세요</option>';
    subtaskSelect.innerHTML = '<option value="">구분을 선택하세요</option>';
    configModeSelect.innerHTML = '<option value="">설정모드를 선택하세요</option>';
    document.getElementById('parametersForm').innerHTML = '';
    executeButton.disabled = true;
    
    if (!taskType) {
        featureSelect.disabled = true;
        return;
    }

    featureSelect.disabled = false;
    subtaskSelect.disabled = true;
    configModeSelect.disabled = true;
    
    let features = [];
    
    if (taskType === 'LAYER2') {
        features = [
            'Link-Aggregation (Manual)',
            'Link-Aggregation (LACP)',
            'VLAN',
            'Spanning-tree'
        ];
    } else if (taskType === '시스템관리') {
        features = [
            'Hostname',
            'User',
            'Enable Password',
            'IP Address',
            'Gateway',
            'NTP',
            'Clock',
            'Remote Sysloging',
            'Telnet',
            'SSH',
            'Firmware Upgrade'
        ];
    } else if (taskType === '네트워크관리') {
        features = [
            'SNMP',
            'SNMP trap',
            'SNMPv3',
            'Port Mirroring',
            'LLDP',
            'Loopback'
        ];
    } else if (taskType === 'QoS') {
        features = [
            'rate-limit'
        ];
    } else if (taskType === '보안') {
        features = [
            'DHCP snooping',
            'DAI',
            'ACL (Standard)',
            'ACL (Extended)'
        ];
    } else if (taskType === '패스워드복구') {
        features = [
            'Password Recovery'
        ];
    }
    
    features.forEach(feature => {
        const option = document.createElement('option');
        option.value = feature;
        option.textContent = feature;
        featureSelect.appendChild(option);
    });
    console.log("Features loaded");
}

async function loadSubtasks() {
    console.log("loadSubtasks 호출됨");
    const taskType = document.getElementById('taskType').value;
    const feature = document.getElementById('feature').value;
    const subtaskSelect = document.getElementById('subtask');
    const configModeSelect = document.getElementById('configMode');
    const executeButton = document.getElementById('executeButton');
    
    subtaskSelect.innerHTML = '<option value="">구분을 선택하세요</option>';
    configModeSelect.innerHTML = '<option value="">설정모드를 선택하세요</option>';
    document.getElementById('parametersForm').innerHTML = '';
    executeButton.disabled = true;
    
    if (!feature) {
        subtaskSelect.disabled = true;
        return;
    }

    subtaskSelect.disabled = false;
    configModeSelect.disabled = true;
    
    // 구분 옵션 설정
    const subtasks = ['config', 'check'];
    subtasks.forEach(subtask => {
        const option = document.createElement('option');
        option.value = subtask;
        option.textContent = subtask === 'config' ? '설정' : '확인';
        subtaskSelect.appendChild(option);
    });
    console.log("Subtasks loaded");
}

async function loadParameters() {
    console.log("loadParameters 호출됨");
    const taskType = document.getElementById('taskType').value;
    const feature = document.getElementById('feature').value;
    const subtask = document.getElementById('subtask').value;
    const configModeSelect = document.getElementById('configMode');
    const executeButton = document.getElementById('executeButton');
    
    configModeSelect.innerHTML = '<option value="">설정모드를 선택하세요</option>';
    document.getElementById('parametersForm').innerHTML = '';
    executeButton.disabled = true;
    
    if (!subtask) {
        configModeSelect.disabled = true;
        return;
    }

    configModeSelect.disabled = false;
    
    if (subtask === 'config') {
        if (feature === 'Spanning-tree') {
            const modes = ['config(RSTP)', 'config(PVST+)'];
            modes.forEach(mode => {
                const option = document.createElement('option');
                option.value = mode;
                option.textContent = mode;
                configModeSelect.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.value = 'config';
            option.textContent = '기본';
            configModeSelect.appendChild(option);
        }
    } else {
        const option = document.createElement('option');
        option.value = 'check';
        option.textContent = '기본';
        configModeSelect.appendChild(option);
    }
    console.log("Parameters loaded");
}

async function updateParameters() {
    console.log("updateParameters 호출됨");
    const taskType = document.getElementById('taskType').value;
    const feature = document.getElementById('feature').value;
    const subtask = document.getElementById('subtask').value;
    const configMode = document.getElementById('configMode').value;
    const parametersForm = document.getElementById('parametersForm');
    const executeButton = document.getElementById('executeButton');
    
    if (!configMode) {
        parametersForm.innerHTML = '';
        executeButton.disabled = true;
        return;
    }

    try {
        console.log(`API 호출: /config/api/parameters/${taskType}/${feature}/${subtask}/${configMode}`);
        const response = await fetch(`/config/api/parameters/${taskType}/${feature}/${subtask}/${configMode}`);
        if (!response.ok) {
            throw new Error('파라미터 로드 실패: ' + response.statusText);
        }
        
        const parameters = await response.json();
        console.log('받은 파라미터:', parameters);
        
        parametersForm.innerHTML = '';
        parameters.forEach(param => {
            const div = document.createElement('div');
            div.className = 'form-group';
            
            const label = document.createElement('label');
            label.textContent = param.label;
            
            let input;
            if (param.type === 'select') {
                input = document.createElement('select');
                input.className = 'form-control';
                param.options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.label;
                    input.appendChild(opt);
                });
            } else {
                input = document.createElement('input');
                input.type = param.type;
                input.className = 'form-control';
                if (param.placeholder) input.placeholder = param.placeholder;
                if (param.min !== undefined) input.min = param.min;
                if (param.max !== undefined) input.max = param.max;
            }
            
            input.id = param.name;
            input.required = param.required;
            
            div.appendChild(label);
            div.appendChild(input);
            parametersForm.appendChild(div);
        });
        
        executeButton.disabled = false;
        console.log("Parameters form updated");
    } catch (error) {
        console.error('파라미터 로드 중 오류:', error);
        parametersForm.innerHTML = `<div class="alert alert-danger">파라미터 로드 실패: ${error.message}</div>`;
        executeButton.disabled = true;
    }
}

async function executeTask() {
    console.log("executeTask 호출됨");
    const taskType = document.getElementById('taskType').value;
    const feature = document.getElementById('feature').value;
    const subtask = document.getElementById('subtask').value;
    const configMode = document.getElementById('configMode').value;
    const parametersForm = document.getElementById('parametersForm');
    const commandOutput = document.getElementById('commandOutput');
    const executeButton = document.getElementById('executeButton');
    
    executeButton.disabled = true;
    
    try {
        // 파라미터 수집
        const parameters = {};
        parametersForm.querySelectorAll('input, select').forEach(input => {
            parameters[input.id] = input.value;
        });
        
        console.log('전송할 데이터:', {
            taskType: taskType,
            feature: feature,
            subtask: subtask,
            configMode: configMode,
            parameters: parameters
        });
        
        const response = await fetch('/config/api/execute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskType: taskType,
                feature: feature,
                subtask: subtask,
                configMode: configMode,
                parameters: parameters
            })
        });
        
        if (!response.ok) {
            throw new Error('작업 실행 실패: ' + response.statusText);
        }
        
        const result = await response.json();
        console.log('받은 결과:', result);
        
        if (result.error) {
            commandOutput.textContent = `오류: ${result.error}`;
            commandOutput.className = 'bg-danger text-white p-3 rounded';
        } else {
            commandOutput.textContent = result.output || '작업이 성공적으로 실행되었습니다.';
            commandOutput.className = 'bg-light p-3 rounded';
        }
    } catch (error) {
        console.error('작업 실행 중 오류:', error);
        commandOutput.textContent = `작업 실행 실패: ${error.message}`;
        commandOutput.className = 'bg-danger text-white p-3 rounded';
    } finally {
        executeButton.disabled = false;
    }
}
</script>
{% endblock %} 