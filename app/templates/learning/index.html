{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>자동 학습</h2>
        <div class="card mb-4">
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="deviceSelect" class="form-label">장치 선택</label>
                        <select class="form-select" id="deviceSelect" multiple>
                            <!-- 장치 목록이 동적으로 로드됩니다 -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="taskTypeSelect" class="form-label">작업 유형 선택</label>
                        <select class="form-select" id="taskTypeSelect" multiple>
                            <!-- 작업 유형 목록이 동적으로 로드됩니다 -->
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <button type="button" class="btn btn-primary" onclick="startLearning()">학습 시작</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 학습된 명령어 조회 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">학습된 명령어 조회</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="vendorFilter" class="form-label">벤더 선택</label>
                        <select class="form-select" id="vendorFilter" onchange="loadLearnedCommands()">
                            <option value="">전체</option>
                            <option value="cisco">Cisco</option>
                            <option value="juniper">Juniper</option>
                            <option value="arista">Arista</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>벤더</th>
                                <th>작업 유형</th>
                                <th>상세 작업</th>
                                <th>명령어 템플릿</th>
                                <th>매개변수</th>
                                <th>마지막 학습 일시</th>
                            </tr>
                        </thead>
                        <tbody id="learnedCommandsTable">
                            <!-- 학습된 명령어 목록이 여기에 동적으로 추가됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 학습 진행 상태 모달 -->
<div class="modal fade" id="learningProgressModal" tabindex="-1" role="dialog" aria-labelledby="learningProgressModalLabel" aria-modal="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="learningProgressModalLabel">학습 진행 중</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <div class="progress">
                    <div id="learningProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div id="learningStatus" class="mt-3" aria-live="polite">
                    <!-- 학습 상태 메시지가 여기에 표시됩니다 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="닫기">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let learningModal = null;
let lastFocusedElement = null;

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', () => {
    initializePage();
});

function initializePage() {
    // 학습된 명령어 로드
    loadLearnedCommands();
    
    // 장치 목록 로드
    fetch('/api/devices')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(devices => {
            const select = document.getElementById('deviceSelect');
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = `${device.name} (${device.vendor})`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('장치 목록 로드 실패:', error);
            showToast('error', `장치 목록 로드 중 오류가 발생했습니다: ${error.message}`);
        });
    
    // 작업 유형 목록 로드
    fetch('/api/learning/task-types')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(taskTypes => {
            const select = document.getElementById('taskTypeSelect');
            taskTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('작업 유형 목록 로드 실패:', error);
            showToast('error', `작업 유형 목록 로드 중 오류가 발생했습니다: ${error.message}`);
        });
    
    // 모달 초기화
    const modalElement = document.getElementById('learningProgressModal');
    learningModal = new bootstrap.Modal(modalElement, {
        keyboard: true,
        backdrop: true
    });
    
    // 모달이 열릴 때 포커스 저장
    modalElement.addEventListener('show.bs.modal', () => {
        lastFocusedElement = document.activeElement;
    });
    
    // 모달이 닫힐 때 포커스 복원
    modalElement.addEventListener('hidden.bs.modal', () => {
        if (lastFocusedElement) {
            lastFocusedElement.focus();
        }
    });
}

// 학습 시작
function startLearning() {
    const deviceSelect = document.getElementById('deviceSelect');
    const taskTypeSelect = document.getElementById('taskTypeSelect');
    
    const selectedDevices = Array.from(deviceSelect.selectedOptions).map(option => option.value);
    const selectedTaskTypes = Array.from(taskTypeSelect.selectedOptions).map(option => option.value);
    
    if (selectedDevices.length === 0 || selectedTaskTypes.length === 0) {
        showToast('error', '장치와 작업 유형을 선택해주세요.');
        return;
    }
    
    // 학습 진행 모달 표시
    learningModal.show();
    
    // 학습 시작 API 호출
    fetch('/api/learning/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            device_id: selectedDevices,
            task_types: selectedTaskTypes
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        learningModal.hide();
        showToast('success', data.message || '명령어 학습이 완료되었습니다.');
        loadLearnedCommands();
    })
    .catch(error => {
        learningModal.hide();
        console.error('학습 실패:', error);
        showToast('error', `학습 중 오류가 발생했습니다: ${error.message}`);
    });
}

// 학습된 명령어 목록 로드
function loadLearnedCommands() {
    const vendorFilter = document.getElementById('vendorFilter').value;
    const url = vendorFilter ? 
        `/api/learning/commands?vendor=${encodeURIComponent(vendorFilter)}` : 
        '/api/learning/commands';
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(commands => {
            updateCommandsTable(commands);
        })
        .catch(error => {
            console.error('명령어 조회 실패:', error);
            showToast('error', `명령어 조회 중 오류가 발생했습니다: ${error.message}`);
        });
}

function updateCommandsTable(commands) {
    const tbody = document.getElementById('learnedCommandsTable');
    tbody.innerHTML = '';
    
    if (commands.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.className = 'text-center';
        cell.textContent = '학습된 명령어가 없습니다.';
        row.appendChild(cell);
        tbody.appendChild(row);
        return;
    }
    
    commands.forEach(cmd => {
        const row = document.createElement('tr');
        
        const vendorCell = document.createElement('td');
        vendorCell.textContent = cmd.vendor;
        
        const taskTypeCell = document.createElement('td');
        taskTypeCell.textContent = cmd.task_type;
        
        const subtaskCell = document.createElement('td');
        subtaskCell.textContent = cmd.subtask;
        
        const commandCell = document.createElement('td');
        const code = document.createElement('code');
        code.textContent = cmd.command;
        commandCell.appendChild(code);
        
        const paramsCell = document.createElement('td');
        paramsCell.textContent = cmd.parameters ? cmd.parameters.join(', ') : '-';
        
        const dateCell = document.createElement('td');
        dateCell.textContent = new Date(cmd.updated_at).toLocaleString();
        
        row.appendChild(vendorCell);
        row.appendChild(taskTypeCell);
        row.appendChild(subtaskCell);
        row.appendChild(commandCell);
        row.appendChild(paramsCell);
        row.appendChild(dateCell);
        
        tbody.appendChild(row);
    });
}

function showToast(type, message) {
    const toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        const container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0`;
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'assertive');
    toastElement.setAttribute('aria-atomic', 'true');
    
    const toastBody = document.createElement('div');
    toastBody.className = 'd-flex';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'toast-body';
    messageDiv.textContent = message;
    
    const closeButton = document.createElement('button');
    closeButton.type = 'button';
    closeButton.className = 'btn-close btn-close-white me-2 m-auto';
    closeButton.setAttribute('data-bs-dismiss', 'toast');
    closeButton.setAttribute('aria-label', '닫기');
    
    toastBody.appendChild(messageDiv);
    toastBody.appendChild(closeButton);
    toastElement.appendChild(toastBody);
    
    const container = document.querySelector('.toast-container');
    container.appendChild(toastElement);
    
    const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>
{% endblock %} 